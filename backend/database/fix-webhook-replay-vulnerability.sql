-- ============================================
-- FIX WEBHOOK REPLAY VULNERABILITY
-- Track processed Stripe events to prevent replay attacks
-- ============================================

-- Table to track processed webhook events
CREATE TABLE IF NOT EXISTS stripe_webhook_events (
  id SERIAL PRIMARY KEY,

  -- Stripe event ID (unique identifier from Stripe)
  stripe_event_id VARCHAR(255) UNIQUE NOT NULL,

  -- Event type (checkout.session.completed, etc.)
  event_type VARCHAR(100) NOT NULL,

  -- Event data (stored for debugging/audit trail)
  event_data JSONB,

  -- Processing status
  status VARCHAR(20) DEFAULT 'processing' CHECK (status IN ('processing', 'completed', 'failed')),

  -- Error message if processing failed
  error_message TEXT,

  -- Timestamps
  received_at TIMESTAMP DEFAULT NOW(),
  processed_at TIMESTAMP,

  -- Prevent duplicate event processing
  CONSTRAINT unique_stripe_event UNIQUE(stripe_event_id)
);

-- Index for fast lookups
CREATE INDEX IF NOT EXISTS idx_stripe_events_event_id ON stripe_webhook_events(stripe_event_id);
CREATE INDEX IF NOT EXISTS idx_stripe_events_type ON stripe_webhook_events(event_type);
CREATE INDEX IF NOT EXISTS idx_stripe_events_status ON stripe_webhook_events(status);

-- Function to check if event was already processed
CREATE OR REPLACE FUNCTION is_stripe_event_processed(event_id VARCHAR)
RETURNS BOOLEAN AS $$
DECLARE
  event_exists BOOLEAN;
BEGIN
  SELECT EXISTS(
    SELECT 1 FROM stripe_webhook_events
    WHERE stripe_event_id = event_id AND status = 'completed'
  ) INTO event_exists;

  RETURN event_exists;
END;
$$ LANGUAGE plpgsql;

-- Function to mark event as processing (prevents concurrent processing)
CREATE OR REPLACE FUNCTION start_processing_stripe_event(
  event_id VARCHAR,
  event_type_param VARCHAR,
  event_data_param JSONB
)
RETURNS BOOLEAN AS $$
BEGIN
  -- Try to insert the event
  INSERT INTO stripe_webhook_events (stripe_event_id, event_type, event_data, status)
  VALUES (event_id, event_type_param, event_data_param, 'processing')
  ON CONFLICT (stripe_event_id) DO NOTHING;

  -- Return true if we successfully inserted (i.e., we should process it)
  -- Return false if event already exists (already being processed or completed)
  RETURN FOUND;
END;
$$ LANGUAGE plpgsql;

-- Function to mark event as completed
CREATE OR REPLACE FUNCTION complete_stripe_event(event_id VARCHAR)
RETURNS VOID AS $$
BEGIN
  UPDATE stripe_webhook_events
  SET status = 'completed', processed_at = NOW()
  WHERE stripe_event_id = event_id;
END;
$$ LANGUAGE plpgsql;

-- Function to mark event as failed
CREATE OR REPLACE FUNCTION fail_stripe_event(event_id VARCHAR, error_msg TEXT)
RETURNS VOID AS $$
BEGIN
  UPDATE stripe_webhook_events
  SET status = 'failed', error_message = error_msg, processed_at = NOW()
  WHERE stripe_event_id = event_id;
END;
$$ LANGUAGE plpgsql;

COMMENT ON TABLE stripe_webhook_events IS
'Tracks all Stripe webhook events to prevent replay attacks.
Each Stripe event ID can only be processed once (UNIQUE constraint).
This prevents attackers from replaying legitimate webhooks to get free memberships.';

COMMENT ON FUNCTION is_stripe_event_processed IS
'Returns true if the Stripe event has already been successfully processed.
Use this to prevent replay attacks.';

COMMENT ON FUNCTION start_processing_stripe_event IS
'Marks a Stripe event as being processed. Returns true if this is the first time
processing this event. Returns false if event was already processed (replay attack).
Uses ON CONFLICT to handle race conditions.';

-- Grant permissions
GRANT ALL ON stripe_webhook_events TO thestudio_admin;
GRANT ALL ON stripe_webhook_events_id_seq TO thestudio_admin;

-- Cleanup old events (optional - run monthly)
-- Keeps last 90 days of events for audit trail
CREATE OR REPLACE FUNCTION cleanup_old_stripe_events()
RETURNS INTEGER AS $$
DECLARE
  deleted_count INTEGER;
BEGIN
  DELETE FROM stripe_webhook_events
  WHERE processed_at < NOW() - INTERVAL '90 days' AND status = 'completed';

  GET DIAGNOSTICS deleted_count = ROW_COUNT;
  RETURN deleted_count;
END;
$$ LANGUAGE plpgsql;

COMMENT ON FUNCTION cleanup_old_stripe_events IS
'Deletes successfully processed events older than 90 days.
Keeps failed events indefinitely for debugging.
Returns count of deleted events.';
